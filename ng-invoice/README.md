# NG-Invoice System

## 概要
NG-Invoice Systemは、FiveM用のQBCore/QBXフレームワーク向け請求書管理システムです。プレイヤーや企業が他のプレイヤーに請求書を発行し、支払いを効率的に管理できる包括的なソリューションを提供します。

## 特徴
- **複数受信者対応**: 一度に複数のプレイヤーに請求書を送信可能
- **ジョブごとのプリセット項目**: 異なる職業に対応した定義済み請求項目
- **割引適用機能**: 請求書に対して割引率を適用可能
- **個人・企業請求の選択**: 個人請求または企業請求を選択可能
- **一括支払い**: 複数の請求書をまとめて支払い可能
- **ボス管理機能**: ボス権限を持つプレイヤー向けの管理機能
- **強制執行機能**: 請求書の支払いを強制的に実行（特定の職業のみ）
- **部分支払い対応**: 所持金が不足している場合、可能な限り引き落とし、残額を記録
- **車両押収システム**: 支払い不能時に車両を押収し、残額支払い後に返還
- **Discord Webhook通知**: 請求書関連アクティビティの詳細な通知

## 依存関係
- [qb-core](https://github.com/qbcore-framework/qb-core) または [qbx-core](https://github.com/Qbox-project/qbx-core)
- [ox_lib](https://github.com/overextended/ox_lib)
- [oxmysql](https://github.com/overextended/oxmysql)

## インストール方法
1. このリポジトリをダウンロード
2. リソースフォルダを `ng-invoice` という名前でFiveM サーバーの `resources` ディレクトリに配置
3. `server.cfg` に以下の行を追加:
```
ensure ng-invoice
```
4. サーバーを再起動または `refresh` コマンド実行後、`ensure ng-invoice` を実行

## 設定方法
`shared/config.lua` ファイルで以下の設定をカスタマイズできます:

### 基本設定
- `Config.Webhook` - Discord通知用のWebhook URL（無効にする場合は `false`）
- `Config.OpenKey` - UIを開くキー（デフォルト: 'F7'）
- `Config.AdminGroup` - 管理者権限グループ（デフォルト: 'group.admin'）
- `Config.QBType` - 使用しているQBCoreのタイプ（'qb' または 'qbx'）

### 通知設定
- `Config.Notifications` - 通知に関する様々な設定（表示方法、音声、時間など）

### バンキングシステム設定
- `Config.BankingSystem` - 使用するバンキングシステム:
  - 'renewed': Renewed-Banking
  - 'qb': QB-Banking
  - 'okok': okokBanking
  - 'qb-management': qb-management

### 強制執行設定
- `Config.ForcePaymentJobs` - 請求書の強制執行が可能な職業リスト
- `Config.ForcePayment.allowNegativeBalance` - 残高マイナスを許可するかどうか
- `Config.ForcePayment.checkAccounts` - 残高チェック対象の口座タイプ

### ジョブ設定
- `Config.JobList` - プリセット請求を使用できる職業リスト
- `Config.JobPaymentRatio` - ジョブごとの収入分配率（%）
- `Config.JobInvoicePresets` - ジョブごとの請求内容プリセット

## 使用方法

### 基本機能
1. `F7`キー（デフォルト）を押して請求書メニューを開く
2. 次の機能を利用できます:
   - **請求書作成**: 近くのプレイヤーに請求書を発行
   - **請求書支払い**: 受け取った請求書の確認と支払い

### 請求書作成
1. メニューから「請求書作成」を選択
2. 請求書名を入力
3. ジョブに応じたプリセット項目から選択するか、その他の金額を入力
4. 割引率を設定（オプション）
5. 個人請求にするかどうかを選択（ジョブで請求時のみ）
6. 請求先のプレイヤーを選択（複数選択可能）

### 請求書支払い
1. メニューから「請求書支払い」を選択
2. 未払いの請求書一覧から個別に支払うか、まとめて支払いを選択
3. 支払い方法（現金または銀行）を選択

### ボス向け機能
ジョブのボス権限を持つプレイヤーは、以下の追加機能を利用できます:
- **請求書リスト（ボス）**: ジョブに関連する全ての請求書を表示
- **請求書の削除**: 不要な請求書を削除
- **強制執行**（特定のジョブのみ）: 請求書の支払いを強制的に実行

## 技術的な詳細
- データベースは自動的に初期化されます
- 請求書のステータスは 'pending'(未払い), 'paid'(支払済), 'cancelled'(キャンセル), 'seized'(押収中)の4種類
- ボス権限はQBCore/QBXの設定に基づいて自動的に判定
- 職業口座と個人口座への支払い分配は設定可能（Config.JobPaymentRatio）

### 強制執行時の動作
1. 銀行口座から可能な限り引き落とし
2. 残額がある場合、現金から可能な限り引き落とし
3. まだ残額がある場合、車両を押収
4. 支払済み金額は `paid_amount` カラムに記録される
5. 請求書のステータスは `seized` に変更され、削除されない
6. 対象者が残額を支払うと、押収された車両が自動的に返還される
7. 全額支払い完了で請求書が削除される

## トラブルシューティング
- **請求書メニューが表示されない場合**:
  - ox_libが正しくインストールされているか確認
  - キーバインドが他のリソースと競合していないか確認
- **支払いが失敗する場合**:
  - 十分な残高があるか確認
  - データベース接続が正常か確認
- **ボス機能にアクセスできない場合**:
  - ジョブのgrade設定で`isboss = true`が正しく設定されているか確認

## クレジット
作成者: NCCGr

## ライセンス
このリソースは、特に明示されていない限り、著作権所有者の許可なく再配布や改変を禁止します。