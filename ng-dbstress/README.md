# ng-dbstress - データベース負荷テストツール

![Version](https://img.shields.io/badge/version-1.0.0-blue.svg)
![FiveM](https://img.shields.io/badge/FiveM-Ready-green.svg)
![QBCore](https://img.shields.io/badge/QBCore-Compatible-orange.svg)

## 📋 概要

**ng-dbstress** は、FiveMサーバーのデータベース耐久性をテストするための管理者専用スクリプトです。様々な負荷パターンでデータベースのパフォーマンスと安定性を検証できます。

### ⚠️ 重要な注意事項

- **このスクリプトはテスト環境専用です**
- 本番環境での使用は推奨しません
- データベースに高負荷をかけるため、他のプレイヤーに影響が出る可能性があります
- 必ずバックアップを取ってから使用してください

---

## ✨ 主な機能

### 🔬 8種類の負荷テスト

1. **📝 連続INSERT テスト**
   - 大量のデータを連続挿入してINSERT性能を測定

2. **🔍 連続SELECT テスト**
   - 大量のデータを連続取得してSELECT性能を測定

3. **✏️ 連続UPDATE テスト**
   - 既存データを連続更新してUPDATE性能を測定

4. **🗑️ 連続DELETE テスト**
   - データを連続削除してDELETE性能を測定

5. **🔗 複雑なJOIN クエリテスト**
   - 重いJOINクエリを実行して複雑なクエリ性能を測定

6. **💳 トランザクション負荷テスト**
   - 大量のトランザクション処理を実行

7. **⚡ 同時接続テスト**
   - 複数の同時クエリを実行してマルチスレッド性能を測定

8. **🎯 全テスト実行**
   - 上記すべてのテストを順番に実行

### 📊 詳細な統計情報

- リアルタイムの実行状況モニタリング
- 成功/失敗カウント
- 平均/最小/最大応答時間
- エラーログ記録
- テスト履歴の保存と閲覧

### ⚙️ 柔軟な設定オプション

- **実行回数**: 10回 ～ 100万回（カスタム設定可能）
- **実行間隔**: 間隔なし ～ 10秒（カスタム設定可能）
- **同時実行数**: 1スレッド ～ 200スレッド（カスタム設定可能）

### 🛡️ 安全機能

- 管理者権限必須
- テスト実行前の確認ダイアログ
- テスト停止機能
- 自動クリーンアップ機能
- テストデータの一括削除機能

---

## 📦 必要要件

### 依存スクリプト

- **qb-core** - QBCoreフレームワーク
- **ox_lib** - UIライブラリ
- **oxmysql** - MySQLリソース

### サーバー要件

- FiveM Server (最新版推奨)
- MySQL 5.7以上 / MariaDB 10.2以上
- 十分なデータベース容量（最低10GB以上推奨）

---

## 🔧 インストール方法

### 1. ファイルの配置

```
server-data/
└── resources/
    └── [custom]/
        └── ng-dbstress/
            ├── fxmanifest.lua
            ├── README.md
            ├── shared/
            │   └── config.lua
            ├── client/
            │   └── main.lua
            └── server/
                ├── database.lua
                ├── tests.lua
                └── main.lua
```

### 2. server.cfg の設定

```cfg
ensure ng-dbstress
```

### 3. 管理者権限の設定

server.cfgまたはpermissions.cfgに以下を追加:

```cfg
# 管理者権限の付与例
add_ace group.admin command.admin allow
add_principal identifier.license:YOUR_LICENSE_HERE group.admin
```

### 4. データベースの確認

リソース起動時に自動的に以下のテーブルが作成されます:

- `ng_dbstress_test` - メインテストテーブル
- `ng_dbstress_logs` - テスト実行ログ
- `ng_dbstress_results` - テスト結果記録

---

## 🎮 使用方法

### 基本的な使い方

1. ゲーム内で管理者としてログイン
2. チャットで `/dbstress` コマンドを実行
3. メニューからテストタイプを選択
4. 実行回数、間隔、スレッド数を設定
5. テストを開始

### コマンド

| コマンド | 説明 | 権限 |
|---------|------|------|
| `/dbstress` | メインメニューを開く | admin |

### メニュー操作

#### メインメニュー
- **🚀 負荷テストを開始**: テストタイプの選択
- **📜 テスト履歴**: 過去のテスト結果を表示
- **🧹 データクリーンアップ**: テストデータを削除

#### テスト設定
1. テストタイプを選択
2. 実行回数を設定（10 ～ 1000000回）
3. 実行間隔を設定（0 ～ 10000ms）
4. 同時実行数を設定（1 ～ 200スレッド）
5. 「✅ テスト開始」を選択

#### テスト実行中
- リアルタイムで進捗を表示
- 「⏹️ テストを停止」で強制停止可能

---

## ⚙️ 設定ファイル (shared/config.lua)

### 主要設定項目

```lua
-- コマンド設定
Config.Command = 'dbstress' -- メニューを開くコマンド

-- デフォルト設定
Config.DefaultSettings = {
    iterations = 100,  -- デフォルト実行回数
    interval = 0,      -- デフォルト実行間隔(ms)
    threads = 1        -- デフォルト同時実行数
}

-- デバッグモード
Config.Debug = true -- trueでコンソールに詳細ログを表示
```

### カスタマイズ可能な項目

- 実行回数の選択肢
- 実行間隔の選択肢
- 同時実行数の選択肢
- 通知メッセージ
- テストデータ生成設定

---

## 📊 テスト結果の見方

### 統計情報

テスト完了時に以下の情報が表示されます:

- **実行数**: 実行されたクエリの総数
- **成功数**: 正常に完了したクエリ数
- **失敗数**: エラーが発生したクエリ数
- **平均応答時間**: クエリの平均実行時間（ミリ秒）
- **最小/最大応答時間**: 最速/最遅のクエリ実行時間

### 履歴の確認

メインメニューから「📜 テスト履歴」を選択すると、過去20件のテスト結果を確認できます。

各履歴には以下の情報が含まれます:
- テストタイプ
- 実行者
- 実行日時
- 統計情報

---

## 🔍 トラブルシューティング

### よくある問題と解決方法

#### 1. メニューが開かない

**原因**: 管理者権限が正しく設定されていない

**解決方法**:
```cfg
# server.cfgで権限を確認
add_ace group.admin command.admin allow
add_principal identifier.license:YOUR_LICENSE group.admin
```

#### 2. テストが開始できない

**原因**: データベース接続エラー

**解決方法**:
- oxmysqlが正しく起動しているか確認
- データベース接続情報を確認
- F8コンソールでエラーを確認

#### 3. テストが途中で止まる

**原因**: データベースの負荷が高すぎる、またはタイムアウト

**解決方法**:
- 実行回数を減らす
- 実行間隔を長くする
- 同時実行数を減らす
- データベースサーバーのリソースを確認

#### 4. エラーログが多い

**原因**: データベースの制約違反、またはリソース不足

**解決方法**:
- データベースのログを確認
- テストデータをクリーンアップ
- データベースの容量を確認

### デバッグモード

`Config.Debug = true` に設定すると、サーバーコンソールに詳細なログが表示されます:

```
[ng-dbstress] データベーステーブルを初期化しました
[ng-dbstress] サンプルデータを100件挿入しました
[ng-dbstress] テスト開始: insert (ID: test_1_1234567890, ログID: 1)
[ng-dbstress] テスト完了: insert (ID: test_1_1234567890)
  実行: 100, 成功: 98, 失敗: 2
  平均応答時間: 15.43ms
```

---

## 🗄️ データベーステーブル構造

### ng_dbstress_test
メインテストテーブル - 様々な型のデータを含む

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INT | 主キー（自動採番） |
| test_string | VARCHAR(255) | テスト用文字列 |
| test_int | INT | テスト用整数 |
| test_float | FLOAT | テスト用小数 |
| test_json | LONGTEXT | テスト用JSON |
| test_blob | BLOB | テスト用バイナリ |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

### ng_dbstress_logs
テスト実行ログ

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INT | 主キー |
| test_type | VARCHAR(50) | テストタイプ |
| player_id | VARCHAR(50) | プレイヤーID |
| player_name | VARCHAR(100) | プレイヤー名 |
| iterations | INT | 実行回数 |
| threads | INT | スレッド数 |
| interval_ms | INT | 実行間隔 |
| status | ENUM | 状態 |
| started_at | TIMESTAMP | 開始日時 |
| completed_at | TIMESTAMP | 完了日時 |

### ng_dbstress_results
テスト結果の詳細統計

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INT | 主キー |
| log_id | INT | ログID（外部キー） |
| query_type | VARCHAR(50) | クエリタイプ |
| queries_executed | INT | 実行数 |
| queries_success | INT | 成功数 |
| queries_failed | INT | 失敗数 |
| avg_response_time | FLOAT | 平均応答時間 |
| min_response_time | FLOAT | 最小応答時間 |
| max_response_time | FLOAT | 最大応答時間 |
| total_time | FLOAT | 合計時間 |
| error_messages | LONGTEXT | エラーメッセージ |
| created_at | TIMESTAMP | 作成日時 |

---

## 🎨 カスタマイズ

### テストデータの変更

`shared/config.lua` の `Config.TestData` で設定可能:

```lua
Config.TestData = {
    stringLength = 100,      -- ランダム文字列の長さ
    jsonDepth = 3,          -- JSONデータの深さ
    maxBlobSize = 1024 * 10 -- BLOB最大サイズ(10KB)
}
```

### 通知メッセージの変更

`shared/config.lua` の `Config.Notifications` で日本語メッセージをカスタマイズ可能

### 新しいテストの追加

1. `shared/config.lua` の `Config.TestTypes` に新しいテストタイプを追加
2. `server/tests.lua` に新しいテスト関数を実装
3. `server/main.lua` の条件分岐に追加

---

## 📈 パフォーマンスベンチマーク

### 推奨テスト設定

#### 軽負荷テスト（日常監視用）
- 実行回数: 100回
- 実行間隔: 100ms
- スレッド数: 1

#### 中負荷テスト（定期検証用）
- 実行回数: 1000回
- 実行間隔: 10ms
- スレッド数: 5

#### 高負荷テスト（耐久性検証用）
- 実行回数: 10000回
- 実行間隔: なし
- スレッド数: 50

#### 極限テスト（限界性能測定用）
- 実行回数: 100000回以上
- 実行間隔: なし
- スレッド数: 100以上

**⚠️ 注意**: 極限テストは必ずテスト環境で実施してください

---

## 🔒 セキュリティ

- すべての機能は管理者権限必須
- クライアント側でも権限チェックを実施
- SQLインジェクション対策済み
- 不正なパラメータの検証

---

## 📝 変更履歴

### Version 1.0.0 (2024-XX-XX)
- 初回リリース
- 8種類の負荷テスト実装
- リアルタイム統計機能
- テスト履歴機能
- データクリーンアップ機能

---

## 🤝 サポート

### 問い合わせ先

- **Discord**: ayusak
- **作成者**: NCCGr

### バグ報告

バグを見つけた場合は、以下の情報を含めて報告してください:
1. FiveMサーバーバージョン
2. 使用しているデータベース（MySQL/MariaDB）
3. エラーメッセージ（F8コンソール、サーバーログ）
4. 再現手順
5. 使用していたテスト設定

---

## 📄 ライセンス

このスクリプトは販売用です。無断での再配布、改変、転売を禁止します。

---

## ⚖️ 免責事項

このスクリプトの使用によって生じたいかなる損害（データの損失、サーバーのダウン、パフォーマンスの低下など）についても、作成者は一切の責任を負いません。

必ずテスト環境で十分な検証を行った上で使用してください。

---

## 🎯 使用上のベストプラクティス

1. **必ずバックアップを取る**
   - テスト前にデータベースの完全バックアップを作成

2. **テスト環境で実施**
   - 本番環境では絶対に使用しない

3. **段階的に負荷を上げる**
   - 最初は軽負荷から開始し、徐々に負荷を上げる

4. **監視を継続**
   - サーバーリソース（CPU、メモリ、ディスクI/O）を監視

5. **定期的なクリーンアップ**
   - テストデータは定期的にクリーンアップ

6. **結果の記録**
   - テスト履歴を定期的に確認し、パフォーマンスの変化を追跡

---

**開発: NCCGr | お問い合わせ: Discord - ayusak**

このREADMEは予告なく更新される場合があります。
